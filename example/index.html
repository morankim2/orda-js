<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href="./jsoneditor/jsoneditor.css" rel="stylesheet" type="text/css">
  <script src="./jsoneditor/jsoneditor.js"></script>
  <script src="./orda-dev.js"></script>
  <style type="text/css">
      body {
          font: 10.5pt arial;
          color: #4d4d4d;
          line-height: 150%;
          width: 500px;
          padding-left: 40px;
      }

      code {
          background-color: #f5f5f5;
      }

      #jsoneditor {
          width: 500px;
          height: 500px;
      }
  </style>
</head>
<body>
<form>
  JSONEditor
  <div id="jsoneditor"></div>
</form>
<script>
  console.log(orda);

  const container = document.getElementById("jsoneditor");
  console.log(orda.SyncType.REALTIME);

  const conf = new orda.ClientConfig("jsoneditor", orda.SyncType.REALTIME, "http://127.0.0.1:29862", "ws://127.0.0.1:18881/mqtt");
  const client = new orda.Client(conf, "js-example");
  client.connect().then(() => {
    console.log("after connect() in index.hml");
    const jsonDoc = client.subscribeOrCreateDocument("jsoneditor-test"); //.createOrSubscribeDocument()
    jsonDoc.sync().then(() => {
      const json = jsonDoc.toJSON();
      console.log(`synced json:${JSON.stringify(json)}`);

      const options = {
        mode: "tree",
        modes: ["code", "form", "text", "tree", "view", "preview"], // allowed modes
        name: "jsonContent",
        onError: function(err) {
          alert(err.toString());
        },
        onEvent: function(node, event) {
          if (event.type === "blur") {
            if ((node.field !== "") && !(node.value === undefined || node === "")) {
              let targetJSON = jsonDoc;
              for (let i = 0; i < node.path.length - 1; i++) {
                const idx = node.path[i];
                if (idx instanceof string) {
                  targetJSON = targetJSON.getFromObject(idx);
                } else if (idx instanceof Number) {
                  targetJSON = targetJSON.getFromArray(idx);
                }
                console.log(JSON.stringify(targetJSON.toJSON()));
              }
              if (targetJSON.getTypeOfJSON() === orda.TypeOfJSON.object) {
                targetJSON.putToObject(node.field, node.value);
              }
            }
          }
        }
      };
      window.editor = new JSONEditor(container, options, json);
      console.log(json);
      console.log(JSON.stringify(json));
    });
  });
</script>
</body>
</html>